---
title: "MySQL处理客户端请求"
date: 2023-08-01T21:31:54+08:00
draft: false
summary: "简单来说 MySQL 主要分为 Server 层和存储引擎层： * **Server 层**：主要包括**连接器、查询缓存、分析器、优化器、执行器**等，所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图，函数等，还有一个通用的日志模块 binlog 日志模块。 * **存储引擎**：*..."
tags: [MySQL]
categories: [Database]
source: csdn
source_id: "132051183"
source_url: "https://blog.csdn.net/qq_25046827/article/details/132051183"
---

![在这里插入图片描述](/images/mysql-handle-client-requests/75f728e10a52eb97be200ed0bbc05c9a.png)



简单来说 MySQL 主要分为 Server 层和存储引擎层：


* **Server 层**：主要包括**连接器、查询缓存、分析器、优化器、执行器**等，所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图，函数等，还有一个通用的日志模块 binlog 日志模块。
* **存储引擎**：**主要负责数据的存储和读取**，采用可以替换的插件式架构，支持 InnoDB、MyISAM、Memory 等多个存储引擎，其中 InnoDB 引擎有自有的日志模块 redolog 模块。现在最常用的存储引擎是 InnoDB，它从 MySQL 5.5 版本开始就被当做默认存储引擎了。


## 一、连接管理


**每当有一个客户端进程连接到服务器进程时，服务器进程都会创建一个进程专门处理与这个客户端的交互。**当客户端退出时会与该服务器断开连接，服务器并不会立即把与该客户端的交互的线程销毁，而是把它缓存起来，在另一个新的客户端再进行连接时，把这个缓存的线程分给新客户端。这样就不用频繁地创建和销毁线程，从而节省了开销。当然线程分的太多也会影响系统性能，所以也可以限制连接到服务器的客户端的梳理。


在客户端发起连接时，需要携带主机信息、用户名、密码等信息，服务器程序会对客户端提供的这些信息进行认证。如果认证失败，服务器程序会拒绝连接。另外如果客户端程序和服务器程序不在一台计算机上，我们还可以通过传输层安全性TLS协议对连接进行加密，从而保证数据传输的安全。


当连接建立后，与该客户端关联的服务器线程会一直等待客户端发送过来的请求。MySQL服务器接受到的请求只是一个文本消息，该文本消息还要经过各种处理。


> 扩展：
>
> 平时Web应用中一般会使用线程池进行数据库连接的管理，因为建立连接是需要时间的，对于业务请求处理而言，直接利用现有可用连接，避免了数据库连接建立（如三次握手、验证账户、密码等）和释放过程的时间开销，从而缩减了系统整体响应时间。
>
> 此外在Java应用中，一般使用ThreadLocal来维护线程的数据库连接，这样可以实现线程之间的相互隔离，并且保证在一个请求上下文中不同DAO都使用一个连接。


## 二、解析与优化


### 1、查询缓存


MySQL服务器程序处理查询请求时会把上次处理过得查询请求和结果存储起来，如果下一次有同样的请求过来，直接从缓存中查找结果就可以了，不需要再去底层的表中查找了。这个查询缓存可以在不同的客户端之间共享。


当然如果两个查询请求有任何字符上的不用，包括空格、注释、大小写等，都会导致缓存不命中。并且如果查询请求中包含某些系统函数、用户自定义变量和函数、系统表（如mysql、information_schema、performance_shcema），这个请求就不会被缓存。


MySQL的缓存系统会检测设计的每张表，只要该表的结构或者数据被修改，比如对表使用了Insert、Update、Delete、Truncate Table、Alter Table、Drop Table和Drop Database等语句，都会使得与该表有关的所有查询缓存无效并被删除。


虽然查询缓存有时候可以提高系统性能，但是也因此需要维护这块缓存而造成一些开销。比如每次都要去查询缓存中检索、请求处理完后需要更新查询缓存等。从MySQL5.7开始不推荐使用查询缓存，**在MySQL8.0中查询缓存被删除。**


### 2、语法解析


如果查询缓存没有命中，接下来就要进入正式的查询阶段了。因为客户端程序发送过来的请求只是一段文本，所以MySQL服务器首先需要对这段文本进行分析，**判断请求的语法是否正确，然后从文本中将要查询的表、各种查询条件都提取出来放到MySQL服务器内部使用的一些数据结构上。**


### 3、查询优化


在语法解析之后欧，服务器程序获得到了需要的信息，比如要查询的表和列是哪些、搜索条件是什么等。然而因为我们写的SQL语句执行起来效率可能不是很高，MySQL的优化程序会对我们的语句做一些优化，如外连接转换为内连接、表达式简化、子查询转化为连接等等。**优化的结果就是生成一个执行计划，这个执行计划表明了应该用哪些索引执行查询，以及表之间的连接顺序是啥样的等等。我们可以使用Explain语句来查看某个语句的执行计划。**



**参考资料**：


《MySQL是怎样运行的——从根上理解MySQL》
